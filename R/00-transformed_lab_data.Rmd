---
title: "Transforming Lab Data from SI-IT"
output: html_notebook
---

## Analysis Plan

- Import lab data
- Check available information
- Convert long format to wide format
  - change the date to visit number
  - only select {HBA1C, microalbumin, ...} labs results from specific clinic

## Import Data
- The data is stored in `./data` directory (not part of github)
```{r import_data}
library(readr)
lab_data <- read_csv("../data/2019_IT_SIH_9.csv", 
   col_types = c("text", "text", "text", 
       "numeric", "date", "numeric", "text", 
       "text", "text", "text"))
```

##Check available data

```{r general description of the data}
library(Hmisc)
describe(lab_data)
```
### Data dictionary
1. `OH_TNO` 
2. `OH_TRX_DT` -- ** Need to check the format of the test dates**
3. `SIH ID` -- SI Health ID
4. `AGE`
5. `OH_BOD` -- date of birth in -YYYY-MM-DD 
6. `OH_SEX` -- **not sure 1/2 coding for which sex** 
7. `OH_CLINIC_CODE` -- for the clinic requesting the tests
8. `OD_TESTCODE` -- Test ID
9. `TI_NAME` -- Test ID Name 
10. `OD_TR_VAL` -- value of the tests? - `OD_TR_VAL` contain lots of "!" exclamation mark --> What does it mean? 

**Check** 
- `OD_TR_VAL` contain lots of "!" exclamation mark --> What does it mean? 

## Convert long to wide
```{r group}
library(dplyr)
#lab_data$`SIH ID` <- factor(lab_data$`SIH ID`)
## not working
## lab_data$visit_id <- lab_data %>% group_indices(paste("SIH ID","TI_NAME","OH_TRX_DT",sep = "-"))

# - sort by test date
# create group id by SIH_ID & Test-ID
lab_data$visit_id <- paste(lab_data$`SIH ID`,lab_data$"TI_NAME",sep="|")
library(data.table)
DT <- data.table(lab_data)
DT[, visit_id2 := seq_len(.N), by=visit_id]
View(DT[c(152,173),])
## Trim data for transformation
lab_data_long <- DT[,c("SIH ID","visit_id2","TI_NAME","OD_TR_VAL")]

library(tidyr)
# https://uc-r.github.io/tidyr
lab_data.wide <- lab_data_long %>% spread(TI_NAME,OD_TR_VAL,fill =NA, convert = FALSE)
```
